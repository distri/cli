<!DOCTYPE html>

<html>
<head>
  <title>source/builder</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="http://strd6.github.io/cdn/parallel/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <ul class="sections">
        
        
        <li id="section-1">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="builder">Builder</h1>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The builder knows how to compile a source tree or individual files into various
build products.</p>
<p>TODO: Should the builder be part of the packager?</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">CSON = require <span class="string">"./cson"</span>
styl = require <span class="string">"styl"</span></code></pre>
</div>
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">arrayToHash</span></span> = (array) -&gt;
  array.reduce (hash, file) -&gt;
    hash[file.path] = file
    hash
  , {}</code></pre>
</div>
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Extend an object with properties.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">extend</span></span> = (target, sources...) -&gt;
  <span class="keyword">for</span> source <span class="keyword">in</span> sources
    <span class="keyword">for</span> name <span class="keyword">of</span> source
      target[name] = source[name]

  <span class="keyword">return</span> target</code></pre>
</div>
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Return a path without a file extension.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">withoutExtension</span></span> = (str) -&gt;
  str.replace(<span class="regexp">/\.[^\.]*$/</span>,<span class="string">""</span>)</code></pre>
</div>
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Return a file extension for a path.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">fileExtension</span></span> = (str) -&gt;
  <span class="keyword">if</span> match = str.match(<span class="regexp">/\.([^\.]*)$/</span>, <span class="string">''</span>)
    match[match.length - <span class="number">1</span>]
  <span class="keyword">else</span>
    <span class="string">''</span></code></pre>
</div>
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><code>stripMarkdown</code> converts a literate file into pure code for compilation or execution.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">stripMarkdown</span></span> = (content) -&gt;
  content.split(<span class="string">"\n"</span>).map (line) -&gt;
    <span class="keyword">if</span> match = (<span class="regexp">/^([ ]{4}|\t)/</span>).exec line
      line[match[<span class="number">0</span>].length..]
    <span class="keyword">else</span>
      <span class="string">""</span>
  .join(<span class="string">"\n"</span>)</code></pre>
</div>
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><code>compileTemplate</code> compiles a haml file into a HAMLjr program.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileTemplate</span></span> = (source) -&gt;
  <span class="string">"""
    module.exports = Function("return " + HAMLjr.compile(<span class="subst">#{JSON.stringify(source)}</span>, {compiler: CoffeeScript}))()
  """</span></code></pre>
</div>
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>stringData</code> exports a string of text. When you require a file that exports
string data it returns the string for you to use in your code. This is handy for
CSS or other textually based data.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">stringData</span></span> = (source) -&gt;
  <span class="string">"module.exports = <span class="subst">#{JSON.stringify(source)}</span>;"</span></code></pre>
</div>
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>compileStyl</code> compiles a styl file into CSS and makes it available as a string
export.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileStyl</span></span> = (source) -&gt;
  styleContent = styl(source, whitespace: <span class="literal">true</span>).toString()

  stringData(styleContent)</code></pre>
</div>
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>compileCoffee</code> compiles a coffee file into JS and adds the sourceURL comment.</p>
<p>TODO: Work with the require component to make the sourceURL unique for files in
modules.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileCoffee</span></span> = (source, path) -&gt;
  <span class="string">"""
    <span class="subst">#{CoffeeScript.compile(source)}</span>
    //# sourceURL=<span class="subst">#{path}</span>
  """</span></code></pre>
</div>
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>compileFile</code> take a fileData and returns a buildData. A buildData has a <code>path</code>,
and properties for what type of content was built.</p>
<p>TODO: Allow for files to generate docs and code at the same time.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">compileFile</span></span> = ({path, content}) -&gt;
  [name, extension] = [withoutExtension(path), fileExtension(path)]

  result =
    <span class="keyword">switch</span> extension
      <span class="keyword">when</span> <span class="string">"js"</span>
        code: content
      <span class="keyword">when</span> <span class="string">"json"</span>
        code: stringData(JSON.parse(content))
      <span class="keyword">when</span> <span class="string">"cson"</span>
        code: stringData(CSON.parse(content))
      <span class="keyword">when</span> <span class="string">"coffee"</span>
        code: compileCoffee(content, path)
      <span class="keyword">when</span> <span class="string">"haml"</span>
        code: compileTemplate(content, name)
      <span class="keyword">when</span> <span class="string">"styl"</span>
        code: compileStyl(content)
      <span class="keyword">when</span> <span class="string">"css"</span>
        code: stringData(content)
      <span class="keyword">when</span> <span class="string">"md"</span>
        <span class="comment"># Separate out code and call compile again</span>
        compileFile
          path: name
          content: stripMarkdown(content)
      <span class="keyword">else</span>
        {}

  result.name ?= name
  result.extension ?= extension

  extend result,
    path: path</code></pre>
</div>
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="builder">Builder</h2>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The builder instance.</p>
<p>TODO: Standardize interface to use promises or pipes.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">Builder</span></span> = -&gt;
  <span class="function"><span class="title">build</span></span> = (fileData) -&gt;
    results = fileData.map ({path, content}) -&gt;
      <span class="keyword">try</span>
        <span class="comment"># TODO: Separate out tests</span>

        compileFile
          path: path
          content: content
      <span class="keyword">catch</span> {location, message}
        <span class="keyword">if</span> location?
          message = <span class="string">"Error on line <span class="subst">#{location.first_line + <span class="number">1</span>}</span>: <span class="subst">#{message}</span>"</span>

        error: <span class="string">"<span class="subst">#{path}</span> - <span class="subst">#{message}</span>"</span>

    errors = results.filter (result) -&gt;
      result.error

    <span class="keyword">if</span> errors.length
      Deferred().reject(errors.map (e) -&gt; e.error)
    <span class="keyword">else</span>
      Deferred().resolve(results)</code></pre>
</div>
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Post processors operate on the built package.</p>
<p>TODO: Maybe we should split post processors into the packager.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  postProcessors = []

  addPostProcessor: (fn) -&gt;
    postProcessors.push fn</code></pre>
</div>
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Compile and build a tree of file data into a distribution. The distribution should
include source files, compiled files, and documentation.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  build: (fileData) -&gt;
    build(fileData)
    .<span class="keyword">then</span> (items) -&gt;
      results = items.filter (item) -&gt;
        item.code
      .map (item) -&gt;
        path: item.name
        content: item.code
        type: <span class="string">"blob"</span>

      pkg =
        source: arrayToHash(fileData)
        distribution: arrayToHash(results)

      postProcessors.forEach (fn) -&gt;
        fn(pkg)

      <span class="keyword">return</span> pkg

module.exports = Builder</code></pre>
</div>
        </li>
        
    </ul>
  </div>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>
<script src="http://strd6.github.io/require/v0.2.2.js"></script><script>
  $.ajax({
    url: "http://strd6.github.io/interactive/v0.8.1.jsonp",
    dataType: "jsonp",
    jsonpCallback: "STRd6/interactive:v0.8.1",
    cache: true
  }).then(function(PACKAGE) {
    Require.generateFor(PACKAGE)("./" + PACKAGE.entryPoint)
  })
</script><script src="../package.js"></script>
</body>
</html>