<!DOCTYPE html>

<html>
<head>
  <title>source/packager</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="http://strd6.github.io/cdn/parallel/docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    <ul class="sections">
        
        
        <li id="section-1">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="packager">Packager</h1>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>HEYO This is taken straight from <a href="https://raw.github.com/STRd6/packager/master/packager.coffee.md">https://raw.github.com/STRd6/packager/master/packager.coffee.md</a></strong></p>
<p>TODO: Learn how to import this as a real package.</p>
<p>The main responsibilities will be bundling dependencies, and creating the
package.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">Packager =</code></pre>
</div>
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If our string is an absolute URL then we assume that the server is CORS enabled
and we can make a cross origin request to collect the JSON data.</p>
<p>We also handle a Github repo dependency. Something like <code>STRd6/issues:master</code>.
This uses JSONP to load the package from the gh-pages branch of the given repo.</p>
<p><code>STRd6/issues:master</code> will be accessible at <code>http://strd6.github.io/issues/master.jsonp</code>.
The callback is the same as the repo info string: <code>window[&quot;STRd6/issues:master&quot;](... DATA ...)</code></p>
<p>Why all the madness? Github pages doesn&#39;t allow CORS right now, so we need to use
the JSONP hack to work around it. Because the files are static we can&#39;t allow the
server to generate a wrapper in response to our query string param so we need to
work out a unique one per file ahead of time. The <code>&lt;user&gt;/&lt;repo&gt;:&lt;ref&gt;</code> string is
unique for all our packages so we use it to determine the URL and name callback.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  collectDependencies: (dependencies, cachedDependencies={}) -&gt;
    names = Object.keys(dependencies)

    Deferred.<span class="keyword">when</span>(names.map (name) -&gt;
      value = dependencies[name]

      <span class="keyword">if</span> <span class="keyword">typeof</span> value <span class="keyword">is</span> <span class="string">"string"</span>
        <span class="keyword">if</span> value.match <span class="regexp">/^http/</span>
          $.getJSON(value)
        <span class="keyword">else</span>
          <span class="keyword">if</span> (match = value.match(<span class="regexp">/([^\/]*)\/([^\:]*)\:(.*)/</span>))
            [callback, user, repo, branch] = match

            url = <span class="string">"http://<span class="subst">#{user}</span>.github.io/<span class="subst">#{repo}</span>/<span class="subst">#{branch}</span>.json.js"</span>

            $.ajax
              url: url
              dataType: <span class="string">"jsonp"</span>
              jsonpCallback: callback
              cache: <span class="literal">true</span>
            .promise()
          <span class="keyword">else</span>
            reject <span class="string">"""
              Failed to parse repository info string <span class="subst">#{value}</span>, be sure it's in the
              form `&lt;user&gt;/&lt;repo&gt;:&lt;ref&gt;` for example: `STRd6/issues:master`
              or `STRd6/editor:v0.9.1`
            """</span>
      <span class="keyword">else</span>
        reject <span class="string">"Can only handle url string dependencies right now"</span>
    ).<span class="keyword">then</span> (results) -&gt;
      bundledDependencies = {}

      names.forEach (name, i) -&gt;
        bundledDependencies[name] = results[i][<span class="number">0</span>]

      <span class="keyword">return</span> bundledDependencies
    , (error) -&gt;
      console.error error
      process.exit(<span class="number">1</span>)</code></pre>
</div>
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Create the standalone components of this package. An html page that loads the
main entry point for demonstration purposes and a json package that can be
used as a dependency in other packages.</p>
<p>The html page is named <code>index.html</code> and is in the folder of the ref, or the root
if our ref is the default branch.</p>
<p>Docs are generated and placed in <code>docs</code> directory as a sibling to <code>index.html</code>.</p>
<p>An application manifest is served up as a sibling to <code>index.html</code> as well.</p>
<p>The <code>.js</code>, <code>.json</code>, and <code>.jsonp</code> build products are placed into the root level,
as siblings to the folder containing <code>index.html</code>. If this branch is the default
then these build products are placed as siblings to <code>index.html</code></p>
<p>The optional second argument is an array of files to be added to the final
package.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  standAlone: (pkg, files=[]) -&gt;
    <span class="keyword">if</span> repository = pkg.repository
      branch = repository.branch

      <span class="keyword">if</span> branch <span class="keyword">is</span> repository.default_branch
        base = <span class="string">""</span>
      <span class="keyword">else</span>
        base = <span class="string">"<span class="subst">#{branch}</span>/"</span>
    <span class="keyword">else</span>
      base = <span class="string">""</span>

    <span class="function"><span class="title">add</span></span> = (path, content) -&gt;
      files.push
        path: path
        content: content

    add <span class="string">"<span class="subst">#{base}</span>index.html"</span>, html(pkg)
    add <span class="string">"<span class="subst">#{base}</span>manifest.appcache"</span>, cacheManifest(pkg)

    json = JSON.stringify(pkg, <span class="literal">null</span>, <span class="number">2</span>)

    <span class="keyword">if</span> branch
      add <span class="string">"<span class="subst">#{branch}</span>.json.js"</span>, jsonpWrapper(repository, json)

    <span class="keyword">return</span> files</code></pre>
</div>
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Generates a standalone page for testing the app.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">  testScripts: (pkg) -&gt;
    {distribution} = pkg

    testProgram = Object.keys(distribution).select (path) -&gt;
      path.match <span class="regexp">/test\//</span>
    .map (testPath) -&gt;
      <span class="string">"require('./<span class="subst">#{testPath}</span>')"</span>
    .join <span class="string">"\n"</span>

    <span class="string">"""
      <span class="subst">#{dependencyScripts(pkg.remoteDependencies)}</span>
      &lt;script&gt;
        <span class="subst">#{packageWrapper(pkg, testProgram)}</span>
      &lt;\/script&gt;
    """</span>

module.exports = Packager</code></pre>
</div>
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            <div class="content"><pre><code class="lang-coffeescript">
</code></pre>
</div>
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Create a rejected deferred with the given message.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">reject</span></span> = (message) -&gt;
  Deferred().reject(message)</code></pre>
</div>
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>A standalone html page for a package.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">html</span></span> = (pkg) -&gt;
  <span class="string">"""
    &lt;!DOCTYPE html&gt;
    &lt;html manifest="manifest.appcache?<span class="subst">#{+<span class="keyword">new</span> Date}</span>"&gt;
    &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /&gt;
    <span class="subst">#{dependencyScripts(pkg.remoteDependencies)}</span>
    &lt;/head&gt;
    &lt;body&gt;
    &lt;script&gt;
    <span class="subst">#{packageWrapper(pkg, "require('./#{pkg.entryPoint}</span>')")}
    &lt;\/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
  """</span></code></pre>
</div>
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>An HTML5 cache manifest for a package.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">cacheManifest</span></span> = (pkg) -&gt;
  <span class="string">"""
    CACHE MANIFEST
    # <span class="subst">#{+ <span class="keyword">new</span> Date}</span>

    CACHE:
    index.html
    <span class="subst">#{(pkg.remoteDependencies <span class="keyword">or</span> []).join("\n")}</span>

    NETWORK:
    https://*
    http://*
    *
  """</span></code></pre>
</div>
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>makeScript</code> returns a string representation of a script tag that has a src
attribute.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">makeScript</span></span> = (src) -&gt;
  <span class="string">"&lt;script src=<span class="subst">#{JSON.stringify(src)}</span>&gt;&lt;\/script&gt;"</span></code></pre>
</div>
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>dependencyScripts</code> returns a string containing the script tags that are
the remote script dependencies of this build.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">dependencyScripts</span></span> = (remoteDependencies=[]) -&gt;
  remoteDependencies.map(makeScript).join(<span class="string">"\n"</span>)</code></pre>
</div>
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Wraps the given data in a JSONP function wrapper. This allows us to host our
packages on Github pages and get around any same origin issues by using JSONP.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">jsonpWrapper</span></span> = (repository, data) -&gt;
  <span class="string">"""
    window["<span class="subst">#{repository.full_name}</span>:<span class="subst">#{repository.branch}</span>"](<span class="subst">#{data}</span>);
  """</span></code></pre>
</div>
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              <div class="pilwrap">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Wrap code in a closure that provides the package and a require function. This
can be used for generating standalone HTML pages, scripts, and tests.</p>

            </div>
            <div class="content"><pre><code class="lang-coffeescript"><span class="function"><span class="title">packageWrapper</span></span> = (pkg, code) -&gt;
  <span class="string">"""
    ;(function(PACKAGE) {
    var oldRequire = window.Require;
    <span class="subst">#{requireSource()}</span>
    var require = Require.generateFor(PACKAGE);
    window.Require = oldRequire;
    <span class="subst">#{code}</span>
    })(<span class="subst">#{JSON.stringify(pkg, <span class="literal">null</span>, <span class="number">2</span>)}</span>);
  """</span>

<span class="function"><span class="title">requireSource</span></span> = -&gt;
  <span class="string">"""
  (function() {
    var cacheFor, circularGuard, defaultEntryPoint, fileSeparator, generateRequireFn, global, isPackage, loadModule, loadPackage, loadPath, normalizePath, rootModule, startsWith,
      __slice = [].slice;

    fileSeparator = '/';

    global = window;

    defaultEntryPoint = "main";

    circularGuard = {};

    rootModule = {
      path: ""
    };

    loadPath = function(parentModule, pkg, path) {
      var cache, localPath, module, normalizedPath;
      if (startsWith(path, '/')) {
        localPath = [];
      } else {
        localPath = parentModule.path.split(fileSeparator);
      }
      normalizedPath = normalizePath(path, localPath);
      cache = cacheFor(pkg);
      if (module = cache[normalizedPath]) {
        if (module === circularGuard) {
          throw "Circular dependency detected when requiring " + normalizedPath;
        }
      } else {
        cache[normalizedPath] = circularGuard;
        try {
          cache[normalizedPath] = module = loadModule(pkg, normalizedPath);
        } finally {
          if (cache[normalizedPath] === circularGuard) {
            delete cache[normalizedPath];
          }
        }
      }
      return module.exports;
    };

    normalizePath = function(path, base) {
      var piece, result;
      if (base == null) {
        base = [];
      }
      base = base.concat(path.split(fileSeparator));
      result = [];
      while (base.length) {
        switch (piece = base.shift()) {
          case "..":
            result.pop();
            break;
          case "":
          case ".":
            break;
          default:
            result.push(piece);
        }
      }
      return result.join(fileSeparator);
    };

    loadPackage = function(parentModule, pkg, path) {
      path || (path = pkg.entryPoint || defaultEntryPoint);
      return loadPath(parentModule, pkg, path);
    };

    loadModule = function(pkg, path) {
      var args, context, dirname, file, module, program, values;
      if (!(file = pkg.distribution[path])) {
        throw "Could not find file at " + path + " in " + pkg.name;
      }
      program = file.content;
      dirname = path.split(fileSeparator).slice(0, -1).join(fileSeparator);
      module = {
        path: dirname,
        exports: {}
      };
      context = {
        require: generateRequireFn(pkg, module),
        global: global,
        module: module,
        exports: module.exports,
        PACKAGE: pkg,
        __filename: path,
        __dirname: dirname
      };
      args = Object.keys(context);
      values = args.map(function(name) {
        return context[name];
      });
      Function.apply(null, __slice.call(args).concat([program])).apply(module, values);
      return module;
    };

    isPackage = function(path) {
      if (!(startsWith(path, fileSeparator) || startsWith(path, "." + fileSeparator) || startsWith(path, ".." + fileSeparator))) {
        return path.split(fileSeparator)[0];
      } else {
        return false;
      }
    };

    generateRequireFn = function(pkg, module) {
      if (module == null) {
        module = rootModule;
      }
      return function(path) {
        var otherPackage, otherPackageName, packagePath;
        if (otherPackageName = isPackage(path)) {
          packagePath = path.replace(otherPackageName, "");
          if (!(otherPackage = pkg.dependencies[otherPackageName])) {
            throw "Package: " + otherPackageName + " not found.";
          }
          if (otherPackage.name == null) {
            otherPackage.name = otherPackageName;
          }
          return loadPackage(rootModule, otherPackage, packagePath);
        } else {
          return loadPath(module, pkg, path);
        }
      };
    };

    if (typeof exports !== "undefined" &amp;&amp; exports !== null) {
      exports.generateFor = generateRequireFn;
    } else {
      global.Require = {
        generateFor: generateRequireFn
      };
    }

    startsWith = function(string, prefix) {
      return string.lastIndexOf(prefix, 0) === 0;
    };

    cacheFor = function(pkg) {
      if (pkg.cache) {
        return pkg.cache;
      }
      Object.defineProperty(pkg, "cache", {
        value: {}
      });
      return pkg.cache;
    };

  }).call(this);
  """</span></code></pre>
</div>
        </li>
        
    </ul>
  </div>
  <script src="//code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/coffee-script/1.6.3/coffee-script.min.js"></script>
<script src="http://strd6.github.io/require/v0.2.2.js"></script><script>
  $.ajax({
    url: "http://strd6.github.io/interactive/v0.8.1.jsonp",
    dataType: "jsonp",
    jsonpCallback: "STRd6/interactive:v0.8.1",
    cache: true
  }).then(function(PACKAGE) {
    Require.generateFor(PACKAGE)("./" + PACKAGE.entryPoint)
  })
</script><script src="../package.js"></script>
</body>
</html>